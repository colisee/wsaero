<!DOCTYPE html>
<html style="height:100%">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="keywords" content="wsaero, metar, taf, weather, aviation, Robin Alexander" />
    <meta name="description" content="Get aviation weather reports" />
    <title>Aero Weather</title>

    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css"/>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
      integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
	  
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
      integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin="">
    </script>

    <!-- Bring in the leaflet KML plugin -->
    <script src="L.KML.js">
    </script>

    <script src="http://www.geoplugin.net/javascript.gp">
    </script>
  </head> 

  <body onload="Load()" style="height:100%"> 

    <header class="w3-cell-row">
      <div class="w3-container w3-blue-grey w3-cell">
        <h2>Aviation Weather</h2>
      </div>
      <div class="w3-container w3-blue-grey w3-cell w3-cell-middle w3-right-align">
        <input type="button" class="w3-button w3-large w3-white" id="showAsText" value="Show as text" onClick="ShowAsText();" />
      </div>
    </header>

    <div id='wsMap' style="height:85%">
    </div>

    <footer class="w3-container w3-blue-grey">
      <h5>Developped by Robin Alexander</h5>
    </footer>


    <script type="text/javascript">

    var thisUrl = document.URL.replace(/\\/g,'/').replace(/\/[^\/]*$/, '');
    var map;
    var kmlLayer = null;
    var zoomAlerted = false;

    function IsZoomCompatible() {

    var zoomLevel = map.getZoom();

      if (!zoomAlerted) {
        if (zoomLevel <= 6) {
          window.alert("Too much data to retrieve at this zoom level. You can drag the map and zoom-in again.");
          zoomAlerted = true;
        }
      }
      else {
        if (zoomLevel > 6) {
          zoomAlerted = false;
        }
      }

      return(zoomLevel > 6) ? true:false;

    }

    function BuildUrl(base) {

      // Get the map viewport coordinates
      var viewport = map.getBounds();
      minLat = viewport.getSouth();
      maxLat = viewport.getNorth();
      minLon = viewport.getWest();
      maxLon = viewport.getEast();

      return(base + '&minLat=' + minLat + '&minLon=' + minLon + '&maxLat=' + maxLat + '&maxLon=' + maxLon);

    }

    function AddKmlLayer(e) {

      // Delete a previous layer if it exists
      if (map.hasLayer(kmlLayer)) {
        map.removeLayer(kmlLayer);
        kmlLayer = null;
      }

      if (IsZoomCompatible()) {
        fetch(BuildUrl(thisUrl + '/wsaero.php?output=KML'))
        .then(res => res.text())
        .then(kmltext => {
          const parser = new DOMParser();
          const kml = parser.parseFromString(kmltext, 'text/xml');
          kmlLayer = new L.KML(kml);
        map.addLayer(kmlLayer);
        });
      }
    }

    function BuildMap(loc, zoom) {

      // Set map center and zoom level
      map.setView(loc, zoom);

      // Set the tile layer from openstreetmap and specify the attributions and max zoom
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '<a href="https://www.openstreetmap.org/">OpenStreetMap</a>, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, <a href="http://weather.aero">@viation digital data service</a>, <a href="http://www.geoplugin.com">Geoplugin</a>',
        maxZoom: 11}).addTo(map);

      // Add a scale control to the map
      L.control.scale().addTo(map);

      // Set function AddKmlLayer as a listener to events "zoomend" and "dragend"
      map.on('zoomend dragend', AddKmlLayer);

      // Display results on the map by firing the 'dragend' event
      map.fire('dragend');

    }

    function onLocationFound(lE) {

      BuildMap(lE.latlng, 9)

    }

    function onLocationError(eE) {

      BuildMap([45, 0], 9)

    }

    function Load() {

      // Create the map object
      map = L.map('wsMap');

      // http protocol is used
      if (document.location.protocol == 'http:') {
        BuildMap([geoplugin_latitude(), geoplugin_longitude()], 9)
      }
      // https protocol is used
      else {
        // The browser supports geolocation
        if (navigator.geolocation) {
          map.locate({setView: true});
          map.on('locationfound', onLocationFound);
          map.on('locationerror', onLocationError);
        }
        // The browser does not support geolocation
        else {
          BuildMap([45, 0], 9)
        }
      }

    }

    function ShowAsText() {

    // Do not use a variable named history as it is the browser history object
    listUrl = BuildUrl(thisUrl + '/wsaero.php?output=HTML');

    // Open a new window to display the result as HTML/text
    window.open(listUrl);

    }

    </script>

  </body>
</html>
