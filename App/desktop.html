<!DOCTYPE html>
<html style="height:100%">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="keywords" content="wsaero, metar, taf, weather, aviation, Robin Alexander" />
    <meta name="description" content="Get aviation weather reports" />
    <title>Aero Weather</title>

    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
      integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
	  
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
      integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin="">
    </script>

    <!-- Bring in the leaflet KML plugin -->
    <script src="L.KML.js">
    </script>

    <script src="http://www.geoplugin.net/javascript.gp">
    </script>
  </head> 

  <body onload="Load()" style="height:100%"> 

    <header class="w3-cell-row">
      <div class="w3-container w3-blue-grey w3-cell">
        <h2>Aviation Weather</h2>
      </div>
      <div class="w3-container w3-blue-grey w3-cell w3-cell-middle w3-right-align">
        <input type="button" class="w3-button w3-large w3-white" id="showAsText" value="Show as text" onClick="ShowAsText();" />
      </div>
    </header>

    <div id='wsMap' style="height:85%">
    </div>

    <footer class="w3-container w3-blue-grey">
      <h5>Developped by Robin Alexander</h5>
    </footer>


    <script type="text/javascript">

    var thisUrl;
    var map;
    var kmlLayer = null;

    function IsZoomCompatible() {

      return(map.getZoom() > 6)?1:0;

    }

    function BuildUrl(base) {

      // Get the map viewport coordinates
      var viewport = map.getBounds();
      minLat = viewport.getSouth();
      maxLat = viewport.getNorth();
      minLon = viewport.getWest();
      maxLon = viewport.getEast();

      return(base + '&minLat=' + minLat + '&minLon=' + minLon + '&maxLat=' + maxLat + '&maxLon=' + maxLon);

    }

    function AddKmlLayer(e) {

      // Delete a previous layer if it exists
      if (map.hasLayer(kmlLayer)) {
        map.removeLayer(kmlLayer);
        kmlLayer = null;
      }

      if (IsZoomCompatible()) {
        fetch(BuildUrl(thisUrl + '/wsaero.php?output=KML'))
        .then(res => res.text())
        .then(kmltext => {
          const parser = new DOMParser();
          const kml = parser.parseFromString(kmltext, 'text/xml');
          kmlLayer = new L.KML(kml);
        map.addLayer(kmlLayer);
        });
	  	}
    }

    function Load() {

      thisUrl = document.URL.replace(/\\/g,'/').replace(/\/[^\/]*$/, '');

      // Get current geographical coordinates
      lon = geoplugin_longitude();
      lat = geoplugin_latitude();

      // Set the leaflet map environment
      map = L.map('wsMap');
      map.setView([lat, lon], 9);
      L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Weather data &copy; <a href="http://weather.aero">@viation digital data service</a>, Geolocation &copy; <a href="http://www.geoplugin.com">Geoplugin</a>',
        maxZoom: 11}).addTo(map);
      L.control.scale().addTo(map);
      map.on('zoomend dragend', AddKmlLayer);

      // Display results on the map by firing the 'dragend' event
      map.fire('dragend');

    }

    function ShowAsText() {

    // Do not use a variable named history as it is the browser history object
    listUrl = BuildUrl(thisUrl + '/wsaero.php?output=HTML');

    // Open a new window to display the result as HTML/text
    window.open(listUrl);

    }

    </script>

  </body>
</html>
